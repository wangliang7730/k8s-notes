---
date: 2021-12-08
updated: 2021-12-13
---

# 4 å‰¯æœ¬æœºåˆ¶å’Œå…¶ä»–æ§åˆ¶å™¨ ï¼šéƒ¨ç½²æ‰˜ç®¡çš„ pod

## 4.1 ä¿æŒ pod å¥åº·

### 4.1.1 ä»‹ç»å­˜æ´»æ¢é’ˆ

**ä¸‰ç§æ¢æµ‹å®¹å™¨çš„æœºåˆ¶ï¼š**

- HTTP GET æ¢é’ˆï¼šå“åº”ç æ˜¯ 2XX æˆ– 3XXï¼Œåˆ™æ¢æµ‹æˆåŠŸã€‚
- TCP å¥—æ¥å­—æ¢é’ˆï¼šå¦‚æœè¿æ¥æˆåŠŸï¼Œåˆ™æ¢æµ‹æˆåŠŸã€‚
- Exec æ‰§è¡Œä»»æ„å‘½ä»¤æ¢é’ˆï¼šå¦‚æœçŠ¶æ€ç æ˜¯ 0ï¼Œåˆ™æ¢æµ‹æˆåŠŸã€‚

### 4.1.2 åˆ›å»ºåŸºäº HTTP çš„å­˜æ´»æ¢é’ˆ

`kubia-liveness-probe.yaml`ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kubia-liveness
spec:
  containers:
  - image: luksa/kubia-unhealthy
    name: kubia
    livenessProbe:
      httpGet:
        path: /
        port: 8080
```

### 4.1.3 ä½¿ç”¨å­˜æ´»æ¢é’ˆ

æŸ¥çœ‹å‰ä¸€ä¸ªæ—¥å¿—ï¼š

```shell
kubectl log mypod --previous
```

### 4.1.4 é…ç½®å­˜æ´»æ¢é’ˆçš„é™„åŠ å±æ€§

`kubia-liveness-probe-initial-delay.yaml`ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kubia-liveness
spec:
  containers:
  - image: luksa/kubia-unhealthy
    name: kubia
    livenessProbe:
      httpGet:
        path: /
        port: 8080
      initialDelaySeconds: 15
```

### 4.1.5 åˆ›å»ºæœ‰æ•ˆçš„å­˜æ´»æ¢é’ˆ

- æ— é¡»åœ¨æ¢é’ˆä¸­å®ç°é‡è¯•å¾ªç¯ã€‚

## 4.2 äº†è§£ ReplicationController

### 4.2.1 ReplicationController çš„æ“ä½œ

- æ›´æ”¹æ ‡ç­¾é€‰æ‹©å™¨å’Œ pod æ¨¡æ¿å¯¹ç°æœ‰ pod æ²¡æœ‰å½±å“ã€‚

### 4.2.2 åˆ›å»ºä¸€ä¸ª ReplicationController

`kubia-rc.yaml`ï¼š

```yaml
apiVersion: v1
kind: ReplicationController
metadata:
  name: kubia
spec:
  replicas: 3
  selector:
    app: kubia
  template:
    metadata:
      labels:
        app: kubia
    spec:
      containers:
      - name: kubia
        image: luksa/kubia
        ports:
        - containerPort: 8080
```

### 4.2.3 ä½¿ç”¨ ReplicationController

```shell
kubectl get rc
```

### 4.2.4 å°† pod ç§»å…¥æˆ–ç§»å‡º ReplicationController çš„ä½œç”¨åŸŸ

ç•¥ã€‚

### 4.2.5 ä¿®æ”¹ pod æ¨¡æ¿

```shell
kubectl edit rc kubia
```

é…ç½® kubectl edit ä½¿ç”¨çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼š

```shell
export KUBE_EDITOR="/usr/bin/nano"
```

### 4.2.6 æ°´å¹³ç¼©æ”¾ pod

```shell
kubectl scale rc kubia --replicas=10
```

### 4.2.7 åˆ é™¤ä¸€ä¸ª ReplicationController

```shell
kubectl delete rc kubia --cascade=false
```

## 4.3 ä½¿ç”¨ ReplicaSet è€Œä¸æ˜¯ ReplicationController

### 4.3.1 æ¯”è¾ƒ ReplicaSet å’Œ ReplicationController

- æ ‡ç­¾é€‰æ‹©å™¨è¯­æ³•æ›´ä¸°å¯Œã€‚

### 4.3.2 å®šä¹‰ ReplicaSet

`kubia-replicaset.yaml`ï¼š

```yaml
apiVersion: apps/v1beta2
kind: ReplicaSet
metadata:
  name: kubia
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kubia
  template:
    metadata:
      labels:
        app: kubia
    spec:
      containers:
      - name: kubia
        image: luksa/kubia
```

> ğŸ™‹â€â™‚ï¸æŠ¥é”™ï¼šerror: unable to recognize "kubia-replicaset.yaml": no matches for kind "ReplicaSet" in version "apps/v1beta2"ï¼šæ”¹ä¸º apps/v1

### 4.3.3 åˆ›å»ºå’Œæ£€æŸ¥ ReplicaSet

```shell
kubectl get rs
```

### 4.3.4 ä½¿ç”¨ ReplicaSet çš„æ›´å¯Œè¡¨è¾¾åŠ›çš„æ ‡ç­¾é€‰æ‹©å™¨

`kubia-replicaset-matchexpressions.yaml`ï¼š

```yaml
selector:
  matchExpressions:
    - key: app
      operator: In
      values:
       - kubia
```

- æœ‰å››ä¸ªè¿ç®—ç¬¦ï¼š`In`ã€`NotIn`ã€`Exists`ã€`DoesNotExist`ã€‚

### 4.3.5 ReplicaSet å°ç»“

ç•¥ã€‚

## 4.4 ä½¿ç”¨ DaemonSet åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª pod

### 4.4.1 ä½¿ç”¨ DaemonSet åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª pod

ç•¥ã€‚

### 4.4.2 ä½¿ç”¨ DaemonSet åªåœ¨ç‰¹å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œ pod

`ssd-monitor-daemonset.yaml`ï¼š

```yaml
apiVersion: apps/v1beta2
kind: DaemonSet
metadata:
  name: ssd-monitor
spec:
  selector:
    matchLabels:
      app: ssd-monitor
  template:
    metadata:
      labels:
        app: ssd-monitor
    spec:
      nodeSelector:
        disk: ssd
      containers:
      - name: main
        image: luksa/ssd-monitor
```

```shell
kubectl get ds
```

## 4.5 è¿è¡Œæ‰§è¡Œå•ä¸ªä»»åŠ¡çš„ pod

### 4.5.1 ä»‹ç» Job èµ„æº

ç•¥ã€‚

### 4.5.2 å®šä¹‰ Job èµ„æº

`batch-job.yaml`ï¼š

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: batch-job
spec:
  template:
    metadata:
      labels:
        app: batch-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: main
        image: luksa/batch-job
```

é‡å¯ç­–ç•¥ï¼š

- Alwaysï¼šé»˜è®¤
- OnFailureã€‚
- Neverã€‚

### 4.5.3 çœ‹ Job è¿è¡Œä¸€ä¸ª pod

```shell
kubectl get jobs

# æ˜¾ç¤ºå®Œæˆçš„ä»»åŠ¡
kubectl get po -a|--show-all
```

### 4.5.4 åœ¨ Job ä¸­è¿è¡Œå¤šä¸ª pod å®ä¾‹

**é¡ºåºè¿è¡Œï¼š**

`multi-completion-batch-job.yaml`ï¼š

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: multi-completion-batch-job
spec:
  completions: 5
  template:
    metadata:
      labels:
        app: batch-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: main
        image: luksa/batch-job
```

**å¹¶è¡Œï¼š**

`multi-completion-parallel-batch-job.yaml`ï¼š

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: multi-completion-batch-job
spec:
  completions: 5
  parallelism: 2
  template:
    metadata:
      labels:
        app: batch-job
    spec:
      restartPolicy: OnFailure
      containers:
      - name: main
        image: luksa/batch-job
```

**ç¼©æ”¾ï¼š**

```shell
# æ›´æ”¹ parallelism å±æ€§
kubectl scale job multi-completion-batch-job --replicas 3
```

### 4.5.5 é™åˆ¶ Job pod å®Œæˆä»»åŠ¡çš„æ—¶é—´

- `activeDeadlineSeconds`ï¼šè¶…æ—¶æ—¶é—´ã€‚
- `spec.backoffLimit`ï¼šå¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 6ã€‚

## 4.6 å®‰æ’ Job å®šæœŸè¿è¡Œæˆ–åœ¨å°†æ¥è¿è¡Œä¸€æ¬¡

### 4.6.1 åˆ›å»ºä¸€ä¸ª CronJob

`cronjob.yaml`ï¼š

```yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: batch-job-every-fifteen-minutes
spec:
  schedule: "0,15,30,45 * * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: periodic-batch-job
        spec:
          restartPolicy: OnFailure
          containers:
          - name: main
            image: luksa/batch-job
```

### 4.6.2 äº†è§£è®¡åˆ’ä»»åŠ¡çš„è¿è¡Œæ–¹å¼

- `startingDeadlineSeconds`ï¼šæœ€è¿Ÿä¸èƒ½è½åäºé¢„å®šæ—¶é—´å¤šå°‘ã€‚

## 4.7 æœ¬ç« å°ç»“

ç•¥ã€‚
