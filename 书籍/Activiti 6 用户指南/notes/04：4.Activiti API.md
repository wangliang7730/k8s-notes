---
title: 4.Activiti API
hidden: true
---

# 4.Activiti API

- [x] 4.1 . æµç¨‹å¼•æ“APIå’ŒæœåŠ¡
- [x] 4.2 . å¼‚å¸¸ç­–ç•¥
- [x] 4.3 . [ä½¿ç”¨ActivitiæœåŠ¡](#ä½¿ç”¨ActivitiæœåŠ¡)
  - 4.3.1 . [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
  - 4.3.2 . [å¯åŠ¨æµç¨‹å®ä¾‹](#å¯åŠ¨æµç¨‹å®ä¾‹)
  - 4.3.3 . [å®Œæˆä»»åŠ¡](#å®Œæˆä»»åŠ¡)
  - 4.3.4 . [æš‚åœå’Œæ¿€æ´»è¿›ç¨‹](#æš‚åœå’Œæ¿€æ´»è¿›ç¨‹)
  - 4.3.5 . [è¿›ä¸€æ­¥é˜…è¯»](#è¿›ä¸€æ­¥é˜…è¯»)
- [x] 4.4 . [æŸ¥è¯¢API](#æŸ¥è¯¢API)
- [x] 4.5 . [å˜é‡](#å˜é‡)
- [x] 4.6 . [ç¬æ€å˜é‡](#ç¬æ€å˜é‡)
- [x] 4.7 . [è¡¨è¾¾å¼](#è¡¨è¾¾å¼)
- [x] 4.8 . [å•å…ƒæµ‹è¯•](#å•å…ƒæµ‹è¯•)
- [x] 4.9 . [è°ƒè¯•å•å…ƒæµ‹è¯•](#è°ƒè¯•å•å…ƒæµ‹è¯•)
- [ ] 4.10 . webåº”ç”¨ç¨‹åºä¸­çš„è¿›ç¨‹å¼•æ“

## ä½¿ç”¨ActivitiæœåŠ¡

### éƒ¨ç½²æµç¨‹

```java
ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
RepositoryService repositoryService = processEngine.getRepositoryService();
repositoryService.createDeployment()
  .addClasspathResource("org/activiti/test/VacationRequest.bpmn20.xml")
  .deploy();

Log.info("Number of process definitions: " + repositoryService.createProcessDefinitionQuery().count());
```

### å¯åŠ¨æµç¨‹å®ä¾‹

```java
Map<String, Object> variables = new HashMap<String, Object>();
variables.put("employeeName", "Kermit");
variables.put("numberOfDays", new Integer(4));
variables.put("vacationMotivation", "I'm really tired!");

RuntimeService runtimeService = processEngine.getRuntimeService();
ProcessInstance processInstance = runtimeService.startProcessInstanceByKey("vacationRequest", variables);

// Verify that we started a new process instance
Log.info("Number of process instances: " + runtimeService.createProcessInstanceQuery().count());
```

### å®Œæˆä»»åŠ¡

```java
// Fetch all tasks for the management group
TaskService taskService = processEngine.getTaskService();
List<Task> tasks = taskService.createTaskQuery().taskCandidateGroup("management").list();
for (Task task : tasks) {
  Log.info("Task available: " + task.getName());
}

Task task = tasks.get(0);

Map<String, Object> taskVariables = new HashMap<String, Object>();
taskVariables.put("vacationApproved", "false");
taskVariables.put("managerMotivation", "We have a tight deadline!");
taskService.complete(task.getId(), taskVariables);
```

### æš‚åœå’Œæ¿€æ´»è¿›ç¨‹

```java
repositoryService.suspendProcessDefinitionByKey("vacationRequest");
try {
  runtimeService.startProcessInstanceByKey("vacationRequest");
} catch (ActivitiException e) {
  e.printStackTrace();
}
```

### è¿›ä¸€æ­¥é˜…è¯»

åœ¨å‰å‡ èŠ‚ä¸­ï¼Œæˆ‘ä»¬åªæ¶‰åŠäº†ActivitiåŠŸèƒ½çš„çš®æ¯›ã€‚æˆ‘ä»¬å°†åœ¨å°†æ¥è¿›ä¸€æ­¥æ‰©å±•è¿™äº›éƒ¨åˆ†ï¼Œå¹¶è¿›ä¸€æ­¥ä»‹ç»Activiti APIã€‚å½“ç„¶ï¼Œä¸ä»»ä½•å¼€æºé¡¹ç›®ä¸€æ ·ï¼Œæœ€å¥½çš„å­¦ä¹ æ–¹æ³•æ˜¯æ£€æŸ¥ä»£ç å¹¶é˜…è¯»Javadocs!

> ğŸ¤¦â€â™‚ï¸ æ„Ÿè§‰ Activiti å®˜æ–¹æ–‡æ¡£ä¹Ÿä¸æ˜¯è¯¦ç»†çš„æ•™ç¨‹ï¼Œéšä¾¿çœ‹çœ‹äº†è§£ä¸€äº›å¤§æ¦‚å°±å¥½

## æŸ¥è¯¢API

æä¾›äº†ä¸¤ç§æŸ¥è¯¢æ–¹å¼ï¼Œä¸€ç§æ˜¯æŸ¥è¯¢ APIï¼š

```java
List<Task> tasks = taskService.createTaskQuery()
    .taskAssignee("kermit")
    .processVariableValueEquals("orderId", "0815")
    .orderByDueDate().asc()
    .list();
```

å¦ä¸€ç§æ˜¯åŸç”ŸæŸ¥è¯¢ï¼š

```java
List<Task> tasks = taskService.createNativeTaskQuery()
  .sql("SELECT count(*) FROM " + managementService.getTableName(Task.class) + " T WHERE T.NAME_ = #{taskName}")
  .parameter("taskName", "gonzoTask")
  .list();

long count = taskService.createNativeTaskQuery()
  .sql("SELECT count(*) FROM " + managementService.getTableName(Task.class) + " T1, "
    + managementService.getTableName(VariableInstanceEntity.class) + " V1 WHERE V1.TASK_ID_ = T1.ID_")
  .count();
```

## å˜é‡

æµç¨‹å®ä¾‹ï¼ˆprocess instanceï¼‰ã€æ‰§è¡ŒæœŸé—´ï¼ˆexecutionï¼‰å’Œç”¨æˆ·ä»»åŠ¡ï¼ˆuser tasksï¼‰æ‹¥æœ‰å˜é‡ï¼Œå­˜åœ¨ `ACT_RU_VARIABLE` ä¸­ï¼š

```java
// e.g. RuntimeService
// å¯åŠ¨æµç¨‹å®ä¾‹æ—¶
ProcessInstance startProcessInstanceByKey(String processDefinitionKey, Map<String, Object> variables);

// æµç¨‹æ‰§è¡ŒæœŸé—´
void setVariable(String executionId, String variableName, Object value);
void setVariableLocal(String executionId, String variableName, Object value);
void setVariables(String executionId, Map<String, ? extends Object> variables);
void setVariablesLocal(String executionId, Map<String, ? extends Object> variables);
```

æµç¨‹å®ä¾‹åŒ…å«äº†ä¸€é¢—æ‰§è¡Œæ ‘ï¼Œ`local` å˜é‡åªæœ‰å½“å‰æ‰§è¡ŒåŠå­æ ‘å¯è§ï¼Œä»»åŠ¡ç±»ä¼¼ã€‚ä¸‹é¢æ˜¯è·å–å˜é‡ï¼š

```java
Map<String, Object> getVariables(String executionId);
Map<String, Object> getVariablesLocal(String executionId);
Map<String, Object> getVariables(String executionId, Collection<String> variableNames);
Map<String, Object> getVariablesLocal(String executionId, Collection<String> variableNames);
Object getVariable(String executionId, String variableName);
<T> T getVariable(String executionId, String variableName, Class<T> variableClass);
```

å˜é‡é€šå¸¸ç”¨åœ¨ Java deletegeã€è¡¨è¾¾å¼ã€execution-ã€ä»»åŠ¡ç›‘å¬å™¨æˆ–è€…è„šæœ¬ç­‰ï¼Œå¯ä»¥ä½¿ç”¨å½“å‰çš„ `execution` æˆ–è€… `task` è®¾ç½®æˆ–è·å–å˜é‡ï¼š

```java
execution.getVariables();
execution.getVariables(Collection<String> variableNames);
execution.getVariable(String variableName);

execution.setVariables(Map<String, object> variables);
execution.setVariable(String variableName, Object value);
// ... local
```

ç”±äºå†å²åŸå› ï¼Œè®¾ç½®æˆ–è·å–ä¸€ä¸ªå˜é‡æ—¶ä¹Ÿä¼šæ“ä½œæ•°æ®åº“æ‰€æœ‰å˜é‡ç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·åšå¹¶ä¸åã€‚5.17 ä¹‹åå¢åŠ äº†ä¸€ä¸ªå˜é‡ç»™ä½ é€‰æ‹©ï¼š

```java
Map<String, Object> getVariables(Collection<String> variableNames, boolean fetchAllVariables);
Object getVariable(String variableName, boolean fetchAllVariables);
void setVariable(String variableName, Object value, boolean fetchAllVariables);
```

## ç¬æ€å˜é‡

```java
void setTransientVariable(String variableName, Object variableValue);
void setTransientVariableLocal(String variableName, Object variableValue);
void setTransientVariables(Map<String, Object> transientVariables);
void setTransientVariablesLocal(Map<String, Object> transientVariables);

Object getTransientVariable(String variableName);
Object getTransientVariableLocal(String variableName);

Map<String, Object> getTransientVariables();
Map<String, Object> getTransientVariablesLocal();

void removeTransientVariable(String variableName);
void removeTransientVariableLocal(String variableName);
```

## è¡¨è¾¾å¼

ä½¿ç”¨ [UEL(Unified Expression Language)](https://docs.oracle.com/javaee/6/tutorial/doc/gjddd.html) è¡¨è¾¾å¼ï¼Œå¯ä»¥ç”¨åœ¨ Java Service ä»»åŠ¡ã€æ‰§è¡Œç›‘å¬å™¨ã€ä»»åŠ¡ç›‘å¬å™¨å’Œæµç¨‹æ¡ä»¶æµè½¬ï¼Œåˆ†ä¸ºï¼š

**å€¼è¡¨è¾¾å¼ï¼š**

```shell
${myVar}
${myBean.myProperty}
```

**æ–¹æ³•è¡¨è¾¾å¼ï¼š**

```shell
${printer.print()}
${myBean.addNewOrder('orderName')}
${myBean.doSomething(myVar, execution)}
# å¯ç”¨çš„å˜é‡
execution
task
authenticatedUserId
```

## å•å…ƒæµ‹è¯•

**Junit3ï¼š**

```java
public class MyBusinessProcessTest extends ActivitiTestCase {

  @Deployment
  public void testSimpleProcess() {
    runtimeService.startProcessInstanceByKey("simpleProcess");

    Task task = taskService.createTaskQuery().singleResult();
    assertEquals("My Task", task.getName());

    taskService.complete(task.getId());
    assertEquals(0, runtimeService.createProcessInstanceQuery().count());
  }
}
```

`testClassName.testMethod.bpmn20.xml` æµç¨‹ä¼šå‘å¸ƒ

**Junit4ï¼š**

```java
public class MyBusinessProcessTest {

  @Rule
  public ActivitiRule activitiRule = new ActivitiRule();

  @Test
  @Deployment
  public void ruleUsageExample() {
    RuntimeService runtimeService = activitiRule.getRuntimeService();
    runtimeService.startProcessInstanceByKey("ruleUsage");

    TaskService taskService = activitiRule.getTaskService();
    Task task = taskService.createTaskQuery().singleResult();
    assertEquals("My Task", task.getName());

    taskService.complete(task.getId());
    assertEquals(0, runtimeService.createProcessInstanceQuery().count());
  }
}
```

## è°ƒè¯•å•å…ƒæµ‹è¯•

```java
// jdbc:h2:mem:activiti
org.h2.tools.Server.createWebServer("-web").start();
```

- http://localhost:8082

> ğŸ™‹â€â™‚ï¸ **è¯´æ˜ï¼š**
>
> - æ‰“æ–­ç‚¹æ•°æ®åº“ä¹Ÿä¼šå¡ä½ï¼Œå¯ä»¥ç”¨çº¿ç¨‹ç­‰å¾…
> - H2 è‡ªå¸¦çš„ç½‘é¡µå·¥å…·å¯ä»¥è¿å†…å­˜æ•°æ®åº“ï¼ŒDBeaver å’Œ IDEA ä¸èƒ½
> - DBeaver å’Œ DBVisualizer è¿æ–‡ä»¶æ•°æ®åº“æ—¶ä¼šç‹¬å æ–‡ä»¶

