---
title: ç¬¬9ç«  å“¨å…µ
hidden: true
date: 2021-09-21
updated: 2021-09-28
---

# ç¬¬9ç«  å“¨å…µ

## 9.1 åŸºæœ¬æ¦‚å¿µ

| ğŸ’¡ **ä»€ä¹ˆæ˜¯å“¨å…µæ¨¡å¼** |
| -------------------- |

### 9.1.1 ä¸»ä»å¤åˆ¶çš„é—®é¢˜

### 9.1.2 é«˜å¯ç”¨

### 9.1.3 Redis Sentinelçš„é«˜å¯ç”¨æ€§

## 9.2 å®‰è£…å’Œéƒ¨ç½²

| ğŸ’¡ **æ­å»ºå“¨å…µæ¨¡å¼** |
| ------------------ |

### 9.2.1 éƒ¨ç½²æ‹“æ‰‘ç»“æ„

### 9.2.2 éƒ¨ç½²Redisæ•°æ®èŠ‚ç‚¹

éƒ¨ç½²ä¸»èŠ‚ç‚¹ï¼š

-   ä¸»èŠ‚ç‚¹é…ç½® `redis-6379.conf`ï¼š

    ```shell
    port 6379
    daemonize yes
    logfile "/var/log/redis/6379.log"
    dbfilename "dump-6379.rdb"
    dir "/opt/redis/data/"
    ```

-  å¯åŠ¨ä¸»èŠ‚ç‚¹ï¼š

    ```shell
    mkdir -p /var/log/redis /opt/redis/data
    redis-server redis-6379.conf
    ```

-  éªŒè¯ï¼š

    ```shell
    redis-cli -h 127.0.0.1 -p 6379 ping
    ```

éƒ¨ç½²ä»èŠ‚ç‚¹ï¼š

-   ä¿®æ”¹ç«¯å£ï¼Œæ·»åŠ ï¼š`slaveof 127.0.0.1 6379`

    ```shell
    # å¯åŠ¨
    redis-server redis-6380.conf
    redis-server redis-6381.conf
    ```

-   éªŒè¯ä¸»ä»å…³ç³»ï¼š

    ```shell
    redis-cli -p 6379 info replication
    redis-cli -p 6380 info replication
    redis-cli -p 6381 info replication
    ```

### 9.2.3 éƒ¨ç½²SentinelèŠ‚ç‚¹

-   é…ç½® `redis-sentinel-26379.conf`

    ```shell
    port 26379
    daemonize yes
    logfile "/var/log/redis/26379.log"
    dir /opt/redis/data
    sentinel monitor mymaster 127.0.0.1 6379 2
    sentinel down-after-milliseconds mymaster 30000
    sentinel parallel-syncs mymaster 1
    sentinel failover-timeout mymaster 180000
    ```

-   å¯åŠ¨

    ```shell
    redis-sentinel redis-sentinel-26379.conf
    # æˆ–è€…
    redis-server redis-sentinel-26379.conf --sentinel
    ```

-   éªŒè¯

    ```shell
    redis-cli -h 127.0.0.1 -p 26379 info sentinel
    ```

-   å¯åŠ¨å¦å¤–ä¸¤ä¸ªå¹¶éªŒè¯

    ```shell
    redis-sentinel redis-sentinel-26380.conf
    redis-sentinel redis-sentinel-26381.conf
    redis-cli -h 127.0.0.1 -p 26380 info sentinel
    redis-cli -h 127.0.0.1 -p 26381 info sentinel
    ```

### 9.2.4 é…ç½®ä¼˜åŒ–

| ğŸ’¡ **å“¨å…µç›¸å…³é…ç½®** |
| ------------------ |

é»˜è®¤é…ç½® `sentinel.conf`ï¼š

```shell
port 26379
dir /tmp
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
#sentinel auth-pass <master-name> <password>
#sentinel notification-script <master-name> <script-path>
#sentinel client-reconfig-script <master-name> <script-path>
```

è¯´æ˜ï¼š

```shell
# ã€æŠ•ç¥¨æ•°ã€‘
sentinel monitor <master-name> <ip> <port> <quorum>
  quorum  # åˆ¤å®šä¸»èŠ‚ç‚¹æœ€ç»ˆä¸å¯è¾¾æ‰€éœ€è¦çš„ç¥¨æ•°
          # è¿˜ä¸ sentinel é€‰ä¸¾æœ‰å…³ï¼Œè‡³å°‘è¦æœ‰ max(quorum,num(sentinels)/2+1) ä¸ª Sentinel èŠ‚ç‚¹å‚ä¸é€‰ä¸¾

# ã€è¶…æ—¶æ—¶é—´ã€‘
sentinel down-after-milliseconds <master-name> <times>
  times   # æ¯«ç§’ã€‚åˆ¤æ–­èŠ‚ç‚¹ä¸å¯è¾¾çš„è¶…æ—¶æ—¶é—´ï¼Œè™½ç„¶åç§°ä¸º master-nameï¼Œä½†æ˜¯å¯¹ Sentinel èŠ‚ç‚¹ã€ä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹çš„å¤±è´¥åˆ¤å®šåŒæ—¶æœ‰æ•ˆ

# ã€å¤åˆ¶èŠ‚ç‚¹ä¸ªæ•°é™åˆ¶ã€‘
sentinel parallel-syncs <master-name> <nums>
  nums    # æ•…éšœè½¬ç§»æ—¶ï¼Œæ¯æ¬¡å‘æ–°çš„ä¸»èŠ‚ç‚¹å‘èµ·å¤åˆ¶æ“ä½œçš„ä»èŠ‚ç‚¹ä¸ªæ•°

# ã€æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´ã€‘
sentinel failover-timeout <master-name> <times>
  times   # æ¯«ç§’ã€‚å®é™…ä¸Šä½œç”¨äºæ•…éšœè½¬ç§»çš„å„ä¸ªé˜¶æ®µ

# ã€ä¸»èŠ‚ç‚¹éªŒè¯ã€‘
sentinel auth-pass <master-name> <password>

# ã€é‡è¦äº‹ä»¶é€šçŸ¥ã€‘
sentinel notification-script <master-name> <script-path>
  script-path # è„šæœ¬é€šè¿‡å‚æ•°æ¥æ”¶

# ã€æ•…éšœè½¬ä¹‰ç»“æŸé€šçŸ¥ã€‘
sentinel client-reconfig-script <master-name> <script-path>
```

**ç›‘æ§å¤šä¸ªä¸»èŠ‚ç‚¹ï¼š**ç”¨ä¸åŒçš„ master-name åŒºåˆ†

**åŠ¨æ€è°ƒæ•´é…ç½®ï¼š**`sentinel set <param> <value>`ï¼Œä¸éœ€è¦ `config rewrite`

### 9.2.5 éƒ¨ç½²æŠ€å·§

## 9.3 API

| ğŸ’¡ **Sentinel ç›¸å…³å‘½ä»¤** |
| ----------------------- |

```shell
sentinel masters
sentinel master <master name>
sentinel slaves <master name>
sentinel sentinels <master name> # ä¸å«å½“å‰
sentinel get-master-addr-by-name <master name>
sentinel reset <pattern> # é‡ç½®ä¸»èŠ‚ç‚¹
sentinel failover <master name> # å¼ºåˆ¶æ•…éšœè½¬ä¹‰
sentinel ckquorum <master name>
sentinel flushconfig
sentinel remove <master name>
sentinel monitor <master name> <ip> <port> <quorum>
sentinel set <param> <value>
sentinel is-master-down-by-addr â±
```

## 9.4 å®¢æˆ·ç«¯è¿æ¥

### 9.4.1 Redis Sentinelçš„å®¢æˆ·ç«¯

### 9.4.2 Redis Sentinelå®¢æˆ·ç«¯åŸºæœ¬å®ç°åŸç†

### 9.4.3 Javaæ“ä½œRedis Sentinel

```java
HashSet<String> sentinels = new HashSet<>();
sentinels.add("localhost:26379");
sentinels.add("localhost:26380");
sentinels.add("localhost:26381");
JedisSentinelPool jedisSentinelPool = new JedisSentinelPool("mymaster", sentinels);
try (Jedis jedis = jedisSentinelPool.getResource()){
    jedis.set("hello", "sentinel");
    System.out.println(jedis.get("hello"));
}
```

jedis ä¼šç›‘å¬ sentinel çš„ `+switch-master` å‘å¸ƒé¢‘é“

## 9.5 å®ç°åŸç†

| ğŸ”‘ **å“¨å…µæ¨¡å¼å®ç°åŸç†** â± |
| ------------------------ |

### 9.5.1 ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡

### 9.5.2 ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿

### 9.5.3 é¢†å¯¼è€…SentinelèŠ‚ç‚¹é€‰ä¸¾

### 9.5.4 æ•…éšœè½¬ç§»

## 9.6 å¼€å‘ä¸è¿ç»´ä¸­çš„é—®é¢˜

### 9.6.1 æ•…éšœè½¬ç§»æ—¥å¿—åˆ†æ

### 9.6.2 èŠ‚ç‚¹è¿ç»´

### 9.6.3 é«˜å¯ç”¨è¯»å†™åˆ†ç¦»

## 9.7 æœ¬ç« é‡ç‚¹å›é¡¾

