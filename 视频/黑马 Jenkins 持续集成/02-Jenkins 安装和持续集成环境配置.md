# 2 Jenkins å®‰è£…å’ŒæŒç»­é›†æˆç¯å¢ƒé…ç½®

## 2.1 æŒç»­é›†æˆæµç¨‹è¯´æ˜

![image-20211223215713184](assets/image-20211223215713184.png)

1. é¦–å…ˆï¼Œå¼€å‘äººå‘˜æ¯å¤©è¿›è¡Œä»£ç æäº¤ï¼Œæäº¤åˆ°Gitä»“åº“ã€‚
2. ç„¶åï¼ŒJenkins ä½œä¸ºæŒç»­é›†æˆå·¥å…·ï¼Œä½¿ç”¨ Git å·¥å…·åˆ° Git ä»“åº“æ‹‰å–ä»£ç åˆ°é›†æˆæœåŠ¡å™¨ï¼Œå†é…åˆ JDKï¼ŒMaven ç­‰è½¯ä»¶å®Œæˆä»£ç ç¼–è¯‘ï¼Œä»£ç æµ‹è¯•ä¸å®¡æŸ¥ã€æµ‹è¯•ã€æ‰“åŒ…ç­‰å·¥ä½œï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¯ä¸€æ­¥å‡ºé”™ï¼Œéƒ½é‡æ–°å†æ‰§è¡Œä¸€æ¬¡æ•´ä¸ªæµç¨‹ã€‚
3. æœ€åï¼ŒJenkins æŠŠç”Ÿæˆçš„ jar æˆ– war åŒ…åˆ†å‘åˆ°æµ‹è¯•æœåŠ¡å™¨æˆ–è€…ç”Ÿäº§æœåŠ¡å™¨ï¼Œæµ‹è¯•äººå‘˜æˆ–ç”¨æˆ·å°±å¯ä»¥è®¿é—®åº”ç”¨ã€‚

### 2.1.1 æœåŠ¡å™¨åˆ—è¡¨

æœ¬è¯¾ç¨‹è™šæ‹Ÿæœºç»Ÿä¸€é‡‡ç”¨ CentOS 7ã€‚

| åç§°           | IP åœ°å€        | å®‰è£…çš„è½¯ä»¶                                            |
| -------------- | -------------- | ----------------------------------------------------- |
| ä»£ç æ‰˜ç®¡æœåŠ¡å™¨ | 192.168.66.100 | Gitlab 12.4.2                                         |
| æŒç»­é›†æˆæœåŠ¡å™¨ | 192.168.66.101 | Jenkins 2.190.3ï¼ŒJDK 1.8ï¼ŒMaven 3.6.2ï¼ŒGitï¼ŒSonarQube |
| åº”ç”¨æµ‹è¯•æœåŠ¡å™¨ | 192.168.66.102 | JDK 1.8ï¼ŒTomcat 8.5                                   |

## 2.2 Gitlab ä»£ç æ‰˜ç®¡æœåŠ¡å™¨å®‰è£…

### 2.2.1 Gitlab ç®€ä»‹

![image-20211223220304747](assets/image-20211223220304747.png)

å®˜ç½‘ï¼š https://about.gitlab.com/ã€‚

GitLab æ˜¯ä¸€ä¸ªç”¨äºä»“åº“ç®¡ç†ç³»ç»Ÿçš„å¼€æºé¡¹ç›®ï¼Œä½¿ç”¨ Git ä½œä¸ºä»£ç ç®¡ç†å·¥å…·ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ­å»ºèµ·æ¥çš„ web æœåŠ¡ã€‚

GitLab å’Œ GitHub ä¸€æ ·å±äºç¬¬ä¸‰æ–¹åŸºäº Git å¼€å‘çš„ä½œå“ï¼Œå…è´¹ä¸”å¼€æºï¼ˆåŸºäº MIT åè®®ï¼‰ï¼Œä¸ Github ç±»ä¼¼ï¼Œå¯ä»¥æ³¨å†Œç”¨æˆ·ï¼Œä»»æ„æäº¤ä½ çš„ä»£ç ï¼Œæ·»åŠ  SSHKey ç­‰ç­‰ã€‚ä¸åŒçš„æ˜¯ï¼ŒGitLab æ˜¯å¯ä»¥éƒ¨ç½²åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œæ•°æ®åº“ç­‰ä¸€åˆ‡ä¿¡æ¯éƒ½æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸Šï¼Œé€‚åˆå›¢é˜Ÿå†…éƒ¨åä½œå¼€å‘ï¼Œä½ æ€»ä¸å¯èƒ½æŠŠå›¢é˜Ÿå†…éƒ¨çš„æ™ºæ…§æ€»æ”¾åœ¨åˆ«äººçš„æœåŠ¡å™¨ä¸Šå§ï¼Ÿç®€å•æ¥è¯´å¯æŠŠ GitLab çœ‹ä½œä¸ªäººç‰ˆçš„ GitHubã€‚

### 2.2.2 Gitlabå®‰è£…

**1. å®‰è£…ç›¸å…³ä¾èµ–**

```shell
yum -y install policycoreutils openssh-server openssh-clients postfix
```

**2. å¯åŠ¨ ssh æœåŠ¡ & è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨**

```shell
systemctl enable sshd && sudo systemctl start sshd
```

**3. è®¾ç½® postfix å¼€æœºè‡ªå¯ï¼Œå¹¶å¯åŠ¨ï¼Œpostfix æ”¯æŒ gitlab å‘ä¿¡åŠŸèƒ½**

```shell
systemctl enable postfix && systemctl start postfix
```

**4. å¼€æ”¾ ssh ä»¥åŠ http æœåŠ¡ï¼Œç„¶åé‡æ–°åŠ è½½é˜²ç«å¢™åˆ—è¡¨**

```shell
firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload
```

å¦‚æœå…³é—­é˜²ç«å¢™å°±ä¸éœ€è¦åšä»¥ä¸Šé…ç½®ã€‚

**5. ä¸‹è½½ gitlab åŒ…ï¼Œå¹¶ä¸”å®‰è£…**

```shell
# åœ¨çº¿ä¸‹è½½å®‰è£…åŒ…
wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm

# å®‰è£…
rpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm
```

> **ğŸ™‹â€â™‚ï¸æŠ¥é”™ï¼š**
>
> **1. -bash: wget: æœªæ‰¾åˆ°å‘½ä»¤**
>
> ```shell
> yum -y install wget
> ```
>
> **2. é”™è¯¯: æ— æ³•éªŒè¯ mirrors.tuna.tsinghua.edu.cn**
>
> ```shell
> wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm --no-check-certificate
> ```
>
> **3. é”™è¯¯ï¼šä¾èµ–æ£€æµ‹å¤±è´¥**
>
> ```shell
> yum -y install gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm
> ```

**6. ä¿®æ”¹ gitlab é…ç½®**

ä¿®æ”¹ gitlab è®¿é—®åœ°å€å’Œç«¯å£ï¼Œé»˜è®¤ä¸º 80ï¼Œæˆ‘ä»¬æ”¹ä¸º 82ï¼š

`/etc/gitlab/gitlab.rb`

```ruby
external_url 'http://192.168.66.100:82'
nginx['listen_port'] = 82
```

**7. é‡è½½é…ç½®åŠå¯åŠ¨ gitlab**

```shell
gitlab-ctl reconfigure
gitlab-ctl restart
```

**8. æŠŠç«¯å£æ·»åŠ åˆ°é˜²ç«å¢™**

```shell
firewall-cmd --zone=public --add-port=82/tcp --permanent
firewall-cmd --reload
```

å¯åŠ¨æˆåŠŸåï¼Œçœ‹åˆ°ä»¥ä¸‹ä¿®æ”¹ç®¡ç†å‘˜ root å¯†ç çš„é¡µé¢ï¼Œä¿®æ”¹å¯†ç åï¼Œç„¶åç™»å½•å³å¯ã€‚

![image-20211223221124609](assets/image-20211223221124609.png)

### 2.2.3 Gitlab æ·»åŠ ç»„ã€åˆ›å»ºç”¨æˆ·ã€åˆ›å»ºé¡¹ç›®

#### åˆ›å»ºç»„

ä½¿ç”¨ç®¡ç†å‘˜ root åˆ›å»ºç»„ï¼Œä¸€ä¸ªç»„é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªé¡¹ç›®åˆ†æ”¯ï¼Œå¯ä»¥å°†å¼€å‘æ·»åŠ åˆ°ç»„é‡Œé¢è¿›è¡Œè®¾ç½®æƒé™ï¼Œä¸åŒçš„ç»„å°±æ˜¯å…¬å¸ä¸åŒçš„å¼€å‘é¡¹ç›®æˆ–è€…æœåŠ¡æ¨¡å—ï¼Œä¸åŒçš„ç»„æ·»åŠ ä¸åŒçš„å¼€å‘å³å¯å®ç°å¯¹å¼€å‘è®¾ç½®æƒé™çš„ç®¡ç†ã€‚

![image-20211223221255907](assets/image-20211223221255907.png)

![image-20211223221301443](assets/image-20211223221301443.png)

#### åˆ›å»ºç”¨æˆ·

åˆ›å»ºç”¨æˆ·çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹© Regular æˆ– Admin ç±»å‹ã€‚

![image-20211223221314179](assets/image-20211223221314179.png)

åˆ›å»ºå®Œç”¨æˆ·åï¼Œç«‹å³ä¿®æ”¹å¯†ç ã€‚

![image-20211223221336649](assets/image-20211223221336649.png)

#### å°†ç”¨æˆ·æ·»åŠ åˆ°ç»„ä¸­

é€‰æ‹©æŸä¸ªç”¨æˆ·ç»„ï¼Œè¿›è¡Œ Members ç®¡ç†ç»„çš„æˆå‘˜ã€‚

![image-20211223221403752](assets/image-20211223221403752.png)

![image-20211223221409433](assets/image-20211223221409433.png)

![image-20211223221413769](assets/image-20211223221413769.png)

Gitlab ç”¨æˆ·åœ¨ç»„é‡Œé¢æœ‰ 5 ç§ä¸åŒæƒé™ï¼š

- **Guestï¼š** å¯ä»¥åˆ›å»ºissueã€å‘è¡¨è¯„è®ºï¼Œä¸èƒ½è¯»å†™ç‰ˆæœ¬åº“ã€‚
- **Reporterï¼š** å¯ä»¥å…‹éš†ä»£ç ï¼Œä¸èƒ½æäº¤ï¼ŒQAã€PM å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ã€‚
- **Developerï¼š** å¯ä»¥å…‹éš†ä»£ç ã€å¼€å‘ã€æäº¤ã€pushï¼Œæ™®é€šå¼€å‘å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ã€‚
- **Maintainerï¼š** å¯ä»¥åˆ›å»ºé¡¹ç›®ã€æ·»åŠ  tagã€ä¿æŠ¤åˆ†æ”¯ã€æ·»åŠ é¡¹ç›®æˆå‘˜ã€ç¼–è¾‘é¡¹ç›®ï¼Œæ ¸å¿ƒå¼€å‘å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ã€‚
- **Ownerï¼š** å¯ä»¥è®¾ç½®é¡¹ç›®è®¿é—®æƒé™ - Visibility Levelã€åˆ é™¤é¡¹ç›®ã€è¿ç§»é¡¹ç›®ã€ç®¡ç†ç»„æˆå‘˜ï¼Œå¼€å‘ç»„ç»„é•¿å¯ä»¥èµ‹äºˆè¿™ä¸ªæƒé™ã€‚

#### åœ¨ç”¨æˆ·ç»„ä¸­åˆ›å»ºé¡¹ç›®

ä»¥åˆšæ‰åˆ›å»ºçš„æ–°ç”¨æˆ·èº«ä»½ç™»å½•åˆ° Gitlabï¼Œç„¶ååœ¨ç”¨æˆ·ç»„ä¸­åˆ›å»ºæ–°çš„é¡¹ç›®ã€‚

![image-20211223221559462](assets/image-20211223221559462.png)

![image-20211223221605510](assets/image-20211223221605510.png)

## 2.3 æºç ä¸Šä¼ åˆ° Gitlab ä»“åº“

ä¸‹é¢æ¥åˆ° IDEA å¼€å‘å·¥å…·ï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½ä¸€ä¸ªç®€å•çš„ Web åº”ç”¨å‡†å¤‡åˆ°é›†æˆéƒ¨ç½²ã€‚

æˆ‘ä»¬è¦æŠŠæºç ä¸Šä¼ åˆ° Gitlab çš„é¡¹ç›®ä»“åº“ä¸­ã€‚

### 2.3.1 é¡¹ç›®ç»“æ„è¯´æ˜

![image-20211223221658673](assets/image-20211223221658673.png)

æˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªéå¸¸ç®€å•çš„ web åº”ç”¨ï¼Œåªæœ‰ä¸€ä¸ª index.jsp é¡µé¢ï¼Œå¦‚æœéƒ¨ç½²å¥½ï¼Œå¯ä»¥è®¿é—®è¯¥é¡µé¢å°±æˆåŠŸå•¦ï¼

### 2.3.2 å¼€å¯ç‰ˆæœ¬æ§åˆ¶

![image-20211223221721887](assets/image-20211223221721887.png)

![image-20211223221726932](assets/image-20211223221726932.png)

### 2.3.3 æäº¤ä»£ç åˆ°æœ¬åœ°ä»“åº“

å…ˆ Add åˆ°ç¼“å­˜åŒºï¼š

![image-20211223221758268](assets/image-20211223221758268.png)

å† Commit åˆ°æœ¬åœ°ä»“åº“ï¼š

![image-20211223221810655](assets/image-20211223221810655.png)

### 2.3.4 æ¨é€åˆ° Gitlab é¡¹ç›®ä»“åº“ä¸­

![image-20211223221843985](assets/image-20211223221843985.png)

è¿™æ—¶ä» Gitlab çš„é¡¹ç›®ä¸­æ‹·è´ url åœ°å€ï¼š

![image-20211223221919708](assets/image-20211223221919708.png)

![image-20211223221904293](assets/image-20211223221904293.png)

è¾“å…¥ Gitlab çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åå°±å¯ä»¥æŠŠä»£ç æ¨é€åˆ°è¿œç¨‹ä»“åº“å•¦ï¼š

![image-20211223221945945](assets/image-20211223221945945.png)

åˆ·æ–° Gitlab é¡¹ç›®ï¼š

![image-20211223222004436](assets/image-20211223222004436.png)

## 2.4 æŒç»­é›†æˆç¯å¢ƒ(1) - Jenkins å®‰è£…

**1. å®‰è£…JDK**

Jenkins éœ€è¦ä¾èµ– JDKï¼Œæ‰€ä»¥å…ˆå®‰è£… JDK 1.8ï¼š

```shell
yum install java-1.8.0-openjdk* -y
```

å®‰è£…ç›®å½•ä¸ºï¼š`/usr/lib/jvm`ã€‚

**2. è·å– Jenkins å®‰è£…åŒ…**

ä¸‹è½½é¡µé¢ï¼šhttps://jenkins.io/zh/download/ã€‚

å®‰è£…æ–‡ä»¶ï¼šjenkins-2.190.3-1.1.noarch.rpmã€‚

**3. æŠŠå®‰è£…åŒ…ä¸Šä¼ åˆ° 192.168.66.101 æœåŠ¡å™¨ï¼Œè¿›è¡Œå®‰è£…**

```shell
rpm -ivh jenkins-2.190.3-1.1.noarch.rpm
```

**4. ä¿®æ”¹ Jenkins é…ç½®**

`/etc/syscofig/jenkins`

```shell
JENKINS_USER="root"
JENKINS_PORT="8888"
```

**5. å¯åŠ¨ Jenkins**

```shell
systemctl start jenkins
```

**6. æ‰“å¼€æµè§ˆå™¨è®¿é—®**

http://192.168.66.101:8888

> **æ³¨æ„ï¼š** æœ¬æœåŠ¡å™¨æŠŠé˜²ç«å¢™å…³é—­äº†ï¼Œå¦‚æœå¼€å¯é˜²ç«å¢™ï¼Œéœ€è¦åœ¨é˜²ç«å¢™æ·»åŠ ç«¯å£ã€‚

**7. è·å–å¹¶è¾“å…¥ admin è´¦æˆ·å¯†ç **

```shell
cat /var/lib/jenkins/secrets/initialAdminPassword
```

**8. è·³è¿‡æ’ä»¶å®‰è£…**

å› ä¸º Jenkins æ’ä»¶éœ€è¦è¿æ¥é»˜è®¤å®˜ç½‘ä¸‹è½½ï¼Œé€Ÿåº¦éå¸¸æ…¢ï¼Œè€Œä¸”ç»è¿‡ä¼šå¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚æ—¶å…ˆè·³è¿‡æ’ä»¶å®‰è£…ã€‚

![image-20211223222629471](assets/image-20211223222629471.png)

![image-20211223222638702](assets/image-20211223222638702.png)

**9. æ·»åŠ ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼Œå¹¶è¿›å…¥ Jenkins åå°**

![image-20211223222658002](assets/image-20211223222658002.png)

![image-20211223222701945](assets/image-20211223222701945.png)

å¼€å§‹ä½¿ç”¨ Jenkinsï¼š

![image-20211223222715309](assets/image-20211223222715309.png)

![image-20211223222724444](assets/image-20211223222724444.png)

## 2.5 æŒç»­é›†æˆç¯å¢ƒ(2) - Jenkins æ’ä»¶ç®¡ç†

Jenkins æœ¬èº«ä¸æä¾›å¾ˆå¤šåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨æ’ä»¶æ¥æ»¡è¶³æˆ‘ä»¬çš„ä½¿ç”¨ã€‚ä¾‹å¦‚ä» Gitlab æ‹‰å–ä»£ç ï¼Œä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ç­‰åŠŸèƒ½éœ€è¦ä¾é æ’ä»¶å®Œæˆã€‚æ¥ä¸‹æ¥æ¼”ç¤ºå¦‚ä½•ä¸‹è½½æ’ä»¶ã€‚

#### 2.5.1 ä¿®æ”¹ Jenkins æ’ä»¶ä¸‹è½½åœ°å€

Jenkins å›½å¤–å®˜æ–¹æ’ä»¶åœ°å€ä¸‹è½½é€Ÿåº¦éå¸¸æ…¢ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹ä¸ºå›½å†…æ’ä»¶åœ°å€ï¼š`Jenkins->Manage Jenkins->Manage Plugins`ï¼Œç‚¹å‡» Availableï¼š

![image-20211223222845296](assets/image-20211223222845296.png)

è¿™æ ·åšæ˜¯ä¸ºäº†æŠŠ Jenkins å®˜æ–¹çš„æ’ä»¶åˆ—è¡¨ä¸‹è½½åˆ°æœ¬åœ°ï¼Œæ¥ç€ä¿®æ”¹åœ°å€æ–‡ä»¶ï¼Œæ›¿æ¢ä¸ºå›½å†…æ’ä»¶åœ°å€ï¼š

```shell
cd /var/lib/jenkins/updates
sed -i 's/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g' default.json && sed -i 's/http:\/\/www.google.com/https:\/\/www.baidu.com/g' default.json
```

æœ€åï¼ŒManage Plugins ç‚¹å‡» Advancedï¼ŒæŠŠ Update Site æ”¹ä¸ºå›½å†…æ’ä»¶ä¸‹è½½åœ°å€ï¼š

```shell
https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
```

![image-20211223223000038](assets/image-20211223223000038.png)

Sumbit åï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ï¼šhttp://192.168.66.101:8888/restartï¼Œé‡å¯ Jenkinsã€‚

#### 2.5.2 ä¸‹è½½ä¸­æ–‡æ±‰åŒ–æ’ä»¶

`Jenkins->Manage Jenkins->Manage Plugins`ï¼Œç‚¹å‡» Availableï¼Œæœç´¢"Chinese"ï¼š

![image-20211223223040150](assets/image-20211223223040150.png)

å®Œæˆåå¦‚ä¸‹å›¾ï¼š

![image-20211223223058480](assets/image-20211223223058480.png)

é‡å¯ Jenkins åï¼Œå°±çœ‹åˆ° Jenkins æ±‰åŒ–äº†ï¼ï¼ˆPSï¼šä½†å¯èƒ½éƒ¨åˆ†èœå•æ±‰åŒ–ä¼šå¤±è´¥ï¼‰

![image-20211223223126201](assets/image-20211223223126201.png)

## 2.6 æŒç»­é›†æˆç¯å¢ƒ(3) - Jenkins ç”¨æˆ·æƒé™ç®¡ç†

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Role-based Authorization Strategy æ’ä»¶æ¥ç®¡ç† Jenkins ç”¨æˆ·æƒé™ã€‚

### 2.6.1 å®‰è£… Role-based Authorization Strategy æ’ä»¶

![image-20211223223653993](assets/image-20211223223653993.png)

### 2.6.2 å¼€å¯æƒé™å…¨å±€å®‰å…¨é…ç½®

![image-20211223223706749](assets/image-20211223223706749.png)

æˆæƒç­–ç•¥åˆ‡æ¢ä¸º"Role-Based Strategy"ï¼Œä¿å­˜ã€‚

![image-20211223223719850](assets/image-20211223223719850.png)

### 2.6.3 åˆ›å»ºè§’è‰²

åœ¨ç³»ç»Ÿç®¡ç†é¡µé¢è¿›å…¥ Manage and Assign Rolesï¼š

![image-20211223223740145](assets/image-20211223223740145.png)

ç‚¹å‡»"Manage Roles"ï¼š

![image-20211223223748941](assets/image-20211223223748941.png)

- **Global rolesï¼ˆå…¨å±€è§’è‰²ï¼‰ï¼š** ç®¡ç†å‘˜ç­‰é«˜çº§ç”¨æˆ·å¯ä»¥åˆ›å»ºåŸºäºå…¨å±€çš„è§’è‰²ã€‚
- **Project rolesï¼ˆé¡¹ç›®è§’è‰²ï¼‰ï¼š** é’ˆå¯¹æŸä¸ªæˆ–è€…æŸäº›é¡¹ç›®çš„è§’è‰²ã€‚
- **Slave rolesï¼ˆå¥´éš¶è§’è‰²ï¼‰ï¼š** èŠ‚ç‚¹ç›¸å…³çš„æƒé™ã€‚

æˆ‘ä»¬æ·»åŠ ä»¥ä¸‹ä¸‰ä¸ªè§’è‰²ï¼š

- **baseRoleï¼š** è¯¥è§’è‰²ä¸ºå…¨å±€è§’è‰²ã€‚è¿™ä¸ªè§’è‰²éœ€è¦ç»‘å®š Overall ä¸‹é¢çš„ Read æƒé™ï¼Œæ˜¯ä¸ºäº†ç»™æ‰€æœ‰ç”¨æˆ·ç»‘å®šæœ€åŸºæœ¬çš„ Jenkins è®¿é—®æƒé™ã€‚æ³¨æ„ï¼šå¦‚æœä¸ç»™åç»­ç”¨æˆ·ç»‘å®šè¿™ä¸ªè§’è‰²ï¼Œä¼šæŠ¥é”™è¯¯ï¼š<font color="red">ç”¨æˆ·å ismissing the Overall/Read permission</font>ã€‚
- **role1ï¼š** è¯¥è§’è‰²ä¸ºé¡¹ç›®è§’è‰²ã€‚ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç»‘å®š`"itcast.*"`ï¼Œæ„æ€æ˜¯åªèƒ½æ“ä½œ `itcast` å¼€å¤´çš„é¡¹ç›®ã€‚
- **role2ï¼š** è¯¥è§’è‰²ä¹Ÿä¸ºé¡¹ç›®è§’è‰²ã€‚ç»‘å®š`"itheima.*"`ï¼Œæ„æ€æ˜¯åªèƒ½æ“ä½œ `itheima` å¼€å¤´çš„é¡¹ç›®ã€‚

![image-20211223224058027](assets/image-20211223224058027.png)

ä¿å­˜ã€‚

### 2.6.4 åˆ›å»ºç”¨æˆ·

åœ¨ç³»ç»Ÿç®¡ç†é¡µé¢è¿›å…¥ Manage Usersï¼š

![image-20211223224121128](assets/image-20211223224121128.png)

![image-20211223224126771](assets/image-20211223224126771.png)

![image-20211223224136353](assets/image-20211223224136353.png)

åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªç”¨æˆ·ï¼šjack å’Œ eric

![image-20211223224150008](assets/image-20211223224150008.png)

### 2.6.5 ç»™ç”¨æˆ·åˆ†é…è§’è‰²

ç³»ç»Ÿç®¡ç†é¡µé¢è¿›å…¥ Manage and Assign Rolesï¼Œç‚¹å‡» Assign Rolesã€‚

ç»‘å®šè§„åˆ™å¦‚ä¸‹ï¼š

- eric ç”¨æˆ·åˆ†åˆ«ç»‘å®š baseRole å’Œ role1 è§’è‰²ã€‚
- jack ç”¨æˆ·åˆ†åˆ«ç»‘å®š baseRole å’Œ role2 è§’è‰²ã€‚

![image-20211223224236567](assets/image-20211223224236567.png)

ä¿å­˜ã€‚

### 2.6.6 åˆ›å»ºé¡¹ç›®æµ‹è¯•æƒé™

ä»¥ itcast ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºä¸¤ä¸ªé¡¹ç›®ï¼Œåˆ†åˆ«ä¸º itcast01 å’Œ itheima01ï¼š

![image-20211223224304279](assets/image-20211223224304279.png)

ç»“æœä¸ºï¼š

- eric ç”¨æˆ·ç™»å½•ï¼Œåªèƒ½çœ‹åˆ° itcast01 é¡¹ç›®ã€‚
- jack ç”¨æˆ·ç™»å½•ï¼Œåªèƒ½çœ‹åˆ° itheima01 é¡¹ç›®ã€‚

## 2.7 æŒç»­é›†æˆç¯å¢ƒ(4) - Jenkins å‡­è¯ç®¡ç†

å‡­æ®å¯ä»¥ç”¨æ¥å­˜å‚¨éœ€è¦å¯†æ–‡ä¿æŠ¤çš„æ•°æ®åº“å¯†ç ã€Gitlab å¯†ç ä¿¡æ¯ã€Docker ç§æœ‰ä»“åº“å¯†ç ç­‰ï¼Œä»¥ä¾¿ Jenkins å¯ä»¥å’Œè¿™äº›ç¬¬ä¸‰æ–¹çš„åº”ç”¨è¿›è¡Œäº¤äº’ã€‚

### 2.7.1 å®‰è£… Credentials Binding æ’ä»¶

è¦åœ¨ Jenkins ä½¿ç”¨å‡­è¯ç®¡ç†åŠŸèƒ½ï¼Œéœ€è¦å®‰è£… Credentials Binding æ’ä»¶ï¼š

![image-20211223224454114](assets/image-20211223224454114.png)

å®‰è£…æ’ä»¶åï¼Œå·¦è¾¹å¤šäº†"å‡­è¯"èœå•ï¼Œåœ¨è¿™é‡Œç®¡ç†æ‰€æœ‰å‡­è¯ï¼š

![image-20211223224504975](assets/image-20211223224504975.png)

å¯ä»¥æ·»åŠ çš„å‡­è¯æœ‰ 5 ç§ï¼š

![image-20211223224517086](assets/image-20211223224517086.png)

- **Username with passwordï¼š** ç”¨æˆ·åå’Œå¯†ç ã€‚
- **SSH Username with private keyï¼š**  ä½¿ç”¨ SSH ç”¨æˆ·å’Œå¯†é’¥ã€‚
- **Secret fileï¼š** éœ€è¦ä¿å¯†çš„æ–‡æœ¬æ–‡ä»¶ï¼Œä½¿ç”¨æ—¶ Jenkins ä¼šå°†æ–‡ä»¶å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­ï¼Œå†å°†æ–‡ä»¶è·¯å¾„è®¾ç½®åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œç­‰æ„å»ºç»“æŸåï¼Œæ‰€å¤åˆ¶çš„ Secret file å°±ä¼šè¢«åˆ é™¤ã€‚
- **Secret textï¼š** éœ€è¦ä¿å­˜çš„ä¸€ä¸ªåŠ å¯†çš„æ–‡æœ¬ä¸²ï¼Œå¦‚é’‰é’‰æœºå™¨äººæˆ– Github çš„ api tokenã€‚
- **Certificateï¼š** é€šè¿‡ä¸Šä¼ è¯ä¹¦æ–‡ä»¶çš„æ–¹å¼ã€‚

å¸¸ç”¨çš„å‡­è¯ç±»å‹æœ‰ï¼š**Username with passwordï¼ˆç”¨æˆ·å¯†ç ï¼‰**å’Œ **SSH Username with private keyï¼ˆSSH å¯†é’¥ï¼‰**ã€‚

æ¥ä¸‹æ¥ä»¥ä½¿ç”¨ Git å·¥å…·åˆ° Gitlab æ‹‰å–é¡¹ç›®æºç ä¸ºä¾‹ï¼Œæ¼”ç¤º Jenkins å¦‚ä½•ç®¡ç† Gitlab çš„å‡­è¯ã€‚

### 2.7.2 å®‰è£… Git æ’ä»¶å’Œ Git å·¥å…·

ä¸ºäº†è®© Jenkins æ”¯æŒä» Gitlab æ‹‰å–æºç ï¼Œéœ€è¦å®‰è£… Git æ’ä»¶ä»¥åŠåœ¨ CentOS7 ä¸Šå®‰è£… Git å·¥å…·ã€‚

Git æ’ä»¶å®‰è£…ï¼š

![image-20211223224734486](assets/image-20211223224734486.png)

CentOS7 ä¸Šå®‰è£… Git å·¥å…·ï¼š

```shell
# å®‰è£…
yum install git -y

# å®‰è£…åæŸ¥çœ‹ç‰ˆæœ¬
git --version
```

### 2.7.3 ç”¨æˆ·å¯†ç ç±»å‹

**1. åˆ›å»ºå‡­è¯**

`Jenkins->å‡­è¯->ç³»ç»Ÿ->å…¨å±€å‡­è¯->æ·»åŠ å‡­è¯`ï¼š

![image-20211223224834985](assets/image-20211223224834985.png)

![image-20211223224839995](assets/image-20211223224839995.png)

é€‰æ‹©"Username with password"ï¼Œè¾“å…¥ Gitlab çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç‚¹å‡»"ç¡®å®š"ã€‚

![image-20211223224853589](assets/image-20211223224853589.png)

**2. æµ‹è¯•å‡­è¯æ˜¯å¦å¯ç”¨**

åˆ›å»ºä¸€ä¸ª FreeStyle é¡¹ç›®ï¼š`æ–°å»ºItem->FreeStyle Project->ç¡®å®š`

![image-20211223224923807](assets/image-20211223224923807.png)

æ‰¾åˆ°`"æºç ç®¡ç†"->"Git"`ï¼Œåœ¨ Repository URL å¤åˆ¶ Gitlab ä¸­çš„é¡¹ç›®URLï¼š

![image-20211223224940767](assets/image-20211223224940767.png)

è¿™æ—¶ä¼šæŠ¥é”™è¯´æ— æ³•è¿æ¥ä»“åº“ï¼åœ¨ Credentials é€‰æ‹©åˆšåˆšæ·»åŠ çš„å‡­è¯å°±ä¸æŠ¥é”™å•¦ã€‚

![image-20211223224955253](assets/image-20211223224955253.png)

ä¿å­˜é…ç½®åï¼Œç‚¹å‡»æ„å»ºâ€Build Nowâ€œ å¼€å§‹æ„å»ºé¡¹ç›®ï¼š

![image-20211223225006080](assets/image-20211223225006080.png)

![image-20211223225011403](assets/image-20211223225011403.png)

æŸ¥çœ‹ `/var/lib/jenkins/workspace/` ç›®å½•ï¼Œå‘ç°å·²ç»ä» Gitlab æˆåŠŸæ‹‰å–äº†ä»£ç åˆ° Jenkins ä¸­ã€‚

![image-20211223225028501](assets/image-20211223225028501.png)

### 2.7.4 SSH å¯†é’¥ç±»å‹

SSHå…å¯†ç™»å½•ç¤ºæ„å›¾ï¼š

![image-20211223225043104](assets/image-20211223225043104.png)

**1. ä½¿ç”¨ root ç”¨æˆ·ç”Ÿæˆå…¬é’¥å’Œç§é’¥**

```shell
ssh-keygen -t rsa
```

åœ¨ `/root/.ssh/` ç›®å½•ä¿å­˜äº†å…¬é’¥å’Œä½¿ç”¨ï¼š

![image-20211223225112717](assets/image-20211223225112717.png)

- `id_rsa`ï¼šç§é’¥æ–‡ä»¶ã€‚
- `id_rsa.pub`ï¼šå…¬é’¥æ–‡ä»¶ã€‚

**2. æŠŠç”Ÿæˆçš„å…¬é’¥æ”¾åœ¨ Gitlab ä¸­**

ä»¥rootè´¦æˆ·ç™»å½•ï¼Œç‚¹å‡» `å¤´åƒ->Settings->SSH Keys`ï¼Œå¤åˆ¶åˆšæ‰ `id_rsa.pub` æ–‡ä»¶çš„å†…å®¹åˆ°è¿™é‡Œï¼Œç‚¹å‡»"Add Key"ï¼š

![image-20211223225237112](assets/image-20211223225237112.png)

**3. åœ¨ Jenkins ä¸­æ·»åŠ å‡­è¯ï¼Œé…ç½®ç§é’¥**

åœ¨ Jenkins æ·»åŠ ä¸€ä¸ªæ–°çš„å‡­è¯ï¼Œç±»å‹ä¸º"SSH Username with private key"ï¼ŒæŠŠåˆšæ‰ç”Ÿæˆç§æœ‰æ–‡ä»¶å†…å®¹å¤åˆ¶è¿‡æ¥ï¼š

![image-20211223225303986](assets/image-20211223225303986.png)

![image-20211223225309166](assets/image-20211223225309166.png)

**4. æµ‹è¯•å‡­è¯æ˜¯å¦å¯ç”¨**

æ–°å»º `"test02"é¡¹ç›®->æºç ç®¡ç†->Git`ï¼Œè¿™æ¬¡è¦ä½¿ç”¨ Gitlab çš„ SSH è¿æ¥ï¼Œå¹¶ä¸”é€‰æ‹© SSH å‡­è¯ï¼š

![image-20211223225333196](assets/image-20211223225333196.png)

![image-20211223225337666](assets/image-20211223225337666.png)

![image-20211223225341517](assets/image-20211223225341517.png)

åŒæ ·å°è¯•æ„å»ºé¡¹ç›®ï¼Œå¦‚æœä»£ç å¯ä»¥æ­£å¸¸æ‹‰å–ï¼Œä»£è¡¨å‡­è¯é…ç½®æˆåŠŸï¼

![image-20211223225349397](assets/image-20211223225349397.png)

## 2.8 æŒç»­é›†æˆç¯å¢ƒ(5) - Maven å®‰è£…å’Œé…ç½®

åœ¨ Jenkins é›†æˆæœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬éœ€è¦å®‰è£… Maven æ¥ç¼–è¯‘å’Œæ‰“åŒ…é¡¹ç›®ã€‚

### 2.8.1 å®‰è£… Maven

å…ˆä¸Šä¼  Maven è½¯ä»¶åˆ° 192.168.66.101ï¼š

```shell
# è§£å‹
tar -xzf apache-maven-3.6.2-bin.tar.gz

# åˆ›å»ºç›®å½•
mkdir -p /opt/maven

# ç§»åŠ¨æ–‡ä»¶
mv apache-maven-3.6.2/* /opt/maven
```

### 2.8.2 é…ç½®ç¯å¢ƒå˜é‡

`/etc/profile`

```shell
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
export MAVEN_HOME=/opt/maven
export PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin
```

ç„¶åï¼š

```shell
# é…ç½®ç”Ÿæ•ˆ
source /etc/profile

# æŸ¥æ‰¾Mavenç‰ˆæœ¬
mvn -v
```

### 2.8.3 å…¨å±€å·¥å…·é…ç½®å…³è” JDK å’Œ Maven

`Jenkins->Global Tool Configuration->JDK->æ–°å¢JDK`ï¼Œé…ç½®å¦‚ä¸‹ï¼š

![image-20211223225657842](assets/image-20211223225657842.png)

`Jenkins->Global Tool Configuration->Maven->æ–°å¢Maven`ï¼Œé…ç½®å¦‚ä¸‹ï¼š

![image-20211223225711975](assets/image-20211223225711975.png)

### 2.8.4 æ·»åŠ  Jenkins å…¨å±€å˜é‡

`Manage Jenkins->Configure System->Global Properties` ï¼Œæ·»åŠ ä¸‰ä¸ªå…¨å±€å˜é‡ï¼š

`JAVA_HOME`ã€`M2_HOME`ã€`PATH+EXTRA`

![image-20211223225805027](assets/image-20211223225805027.png)

### 2.8.5 ä¿®æ”¹ Maven çš„ settings.xml

```shell
# åˆ›å»ºæœ¬åœ°ä»“åº“ç›®å½•
mkdir /root/repo
```

`/opt/maven/conf/settings.xml`

```xml
<settings ...>
    ...
    <!-- æœ¬åœ°ä»“åº“æ”¹ä¸º /root/repo/ -->
    <localRepository>/root/repo/</localRepository>
    ...
    <!-- æ·»åŠ é˜¿é‡Œäº‘ç§æœåœ°å€ -->
    <mirror>
        <id>aliyunmaven</id>
        <mirrorOf>*</mirrorOf>
        <name>é˜¿é‡Œäº‘å…¬å…±ä»“åº“</name>
        <url>https://maven.aliyun.com/repository/public</url>
    </mirror>
    ...
</settings>
```

> ğŸ™‹â€â™‚ï¸ é•œåƒä»“åº“é…ç½®å‚è€ƒï¼šhttps://developer.aliyun.com/mvn/guideã€‚

### 2.8.6 æµ‹è¯• Maven æ˜¯å¦é…ç½®æˆåŠŸ

ä½¿ç”¨ä¹‹å‰çš„ Gitlab å¯†ç æµ‹è¯•é¡¹ç›®ï¼Œä¿®æ”¹é…ç½®ï¼š

![image-20211223230731137](assets/image-20211223230731137.png)

`æ„å»º->å¢åŠ æ„å»ºæ­¥éª¤->Execute Shell`ï¼š

![image-20211223230741146](assets/image-20211223230741146.png)

è¾“å…¥ï¼š

```shell
mvn clean package
```

![image-20211223230754951](assets/image-20211223230754951.png)

å†æ¬¡æ„å»ºï¼Œå¦‚æœå¯ä»¥æŠŠé¡¹ç›®æ‰“æˆ wa råŒ…ï¼Œä»£è¡¨ Maven ç¯å¢ƒé…ç½®æˆåŠŸå•¦ï¼

![image-20211223230811046](assets/image-20211223230811046.png)

## 2.9 æŒç»­é›†æˆç¯å¢ƒ(6)- Tomcat å®‰è£…å’Œé…ç½®

### 2.9.1 å®‰è£… Tomcat 8.5

æŠŠ Tomcat å‹ç¼©åŒ…ä¸Šä¼ åˆ° 192.168.66.102 æœåŠ¡å™¨ï¼š

```shell
#  å®‰è£…JDKï¼ˆå·²å®Œæˆï¼‰
yum install java-1.8.0-openjdk* -y

# è§£å‹
tar -xzf apache-tomcat-8.5.47.tar.gz

# åˆ›å»ºç›®å½•
mkdir -p /opt/tomcat

# ç§»åŠ¨æ–‡ä»¶
mv /root/apache-tomcat-8.5.47/* /opt/tomcat

# å¯åŠ¨tomcat
/opt/tomcat/bin/startup.sh
```

> **æ³¨æ„ï¼š** æœåŠ¡å™¨å·²ç»å…³é—­äº†é˜²ç«å¢™ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è®¿é—® Tomcat å•¦ã€‚

åœ°å€ä¸ºï¼šhttp://192.168.66.102/8080ã€‚

![image-20211223231021549](assets/image-20211223231021549.png)

### 2.9.2 é…ç½® Tomcat ç”¨æˆ·è§’è‰²æƒé™

é»˜è®¤æƒ…å†µä¸‹ Tomcat æ˜¯æ²¡æœ‰é…ç½®ç”¨æˆ·è§’è‰²æƒé™çš„ï¼š

![image-20211223231043223](assets/image-20211223231043223.png)

![image-20211223231049728](assets/image-20211223231049728.png)

ä½†æ˜¯ï¼Œåç»­ Jenkins éƒ¨ç½²é¡¹ç›®åˆ° Tomcat æœåŠ¡å™¨ï¼Œéœ€è¦ç”¨åˆ° Tomcat çš„ç”¨æˆ·ï¼Œæ‰€ä»¥ä¿®æ”¹ Tomcat ä»¥ä¸‹é…ç½®ï¼Œæ·»åŠ ç”¨æˆ·åŠæƒé™ï¼š

`/opt/tomcat/conf/tomcat-users.xml`

```xml
<tomcat-users>
    <role rolename="tomcat"/>
    <role rolename="role1"/>
    <role rolename="manager-script"/>
    <role rolename="manager-gui"/>
    <role rolename="manager-status"/>
    <role rolename="admin-gui"/>
    <role rolename="admin-script"/>
    <user username="tomcat" password="tomcat" roles="manager-gui,manager-
                                                     script,tomcat,admin-gui,admin-script"/>
</tomcat-users>
```

ç”¨æˆ·å’Œå¯†ç éƒ½æ˜¯ï¼štomcatã€‚

> æ³¨æ„ï¼šä¸ºäº†èƒ½å¤Ÿåˆšæ‰é…ç½®çš„ç”¨æˆ·ç™»å½•åˆ° Tomcatï¼Œè¿˜éœ€è¦ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

`/opt/tomcat/webapps/manager/META-INF/context.xml`

```xml
<!--
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" />
-->
```

æŠŠä¸Šé¢è¿™è¡Œæ³¨é‡Šæ‰å³å¯ï¼

### 2.9.3 é‡å¯ Tomcatï¼Œè®¿é—®æµ‹è¯•

```shell
# åœæ­¢
/opt/tomcat/bin/shutdown.sh

# å¯åŠ¨
/opt/tomcat/bin/startup.sh
```

è®¿é—®ï¼šhttp://192.168.66.102:8080/manager/htmlï¼Œè¾“å…¥ tomcat å’Œ tomcatï¼Œçœ‹åˆ°ä»¥ä¸‹é¡µé¢ä»£è¡¨æˆåŠŸå•¦ã€‚

![image-20211223231330572](assets/image-20211223231330572.png)

